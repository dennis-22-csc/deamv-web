name: Deploy DeamV Web to DigitalOcean

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Setup Node.js Environment
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.19.0'
          cache: 'npm'

      # 2. Build Next.js Application and create a reliable archive (FIXED)
      - name: Install dependencies and build Next.js app
        run: |
          npm install --force
          npm run build
          
          echo "Starting artifact packaging to avoid 'file changed' error..."
          
          # 1. Create a clean temporary directory
          mkdir -p build_archive_temp
          
          # 2. Use rsync to copy ONLY necessary files, excluding node_modules and .git
          # This copies the build artifacts (.next) and source files to the temporary folder
          rsync -av \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'nextjs_build.tar.gz' \
            ./ build_archive_temp/
          
          # 3. Create a compressed archive of the contents *inside* the temp directory
          # The -C flag changes the directory before creating the archive, ensuring a clean root path
          tar -czf nextjs_build.tar.gz -C build_archive_temp .
          
          # 4. Clean up the temporary folder
          rm -rf build_archive_temp
        
      # 3. Verify files exist locally before copying
      - name: Verify deployment file locally
        run: |
          echo "Checking local deployment file:"
          ls -la nextjs_build.tar.gz || { echo "ERROR: nextjs_build.tar.gz missing"; exit 1; }
          echo "File size:"
          du -h nextjs_build.tar.gz

      # 4. Copy files to server
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          source: "nextjs_build.tar.gz"
          target: "~/deployments"
          rm: true 

      # 5. SSH into server & deploy
      - name: SSH into server & deploy with backup rotation
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            echo "Starting Next.js deployment process..."
            
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            BASE_DIR="/var/www/deamv-web" # Target directory for the application
            DEPLOY_DIR="$HOME/deployments"
            
            # --- Utility Function ---
            rotate_backups() {
              local DIR=$1
              if [ -d "$DIR" ]; then
                echo "Creating backup of $DIR"
                # Exclude node_modules from backup to save space/time
                tar -czf "${DIR}_backup_$TIMESTAMP.tar.gz" --exclude=node_modules "$DIR"
                # Keep only the last 3 backups (tar.gz files)
                ls -dt ${DIR}_backup_*.tar.gz 2>/dev/null | tail -n +4 | xargs -r rm -f
              else
                echo "Directory $DIR does not exist, no backup needed"
              fi
            }

            # 5a. Verify deployment file
            echo "Checking for deployment file in $DEPLOY_DIR..."
            if [ ! -f "$DEPLOY_DIR/nextjs_build.tar.gz" ]; then
              echo "ERROR: nextjs_build.tar.gz not found!"
              exit 1
            fi

            # 5b. Deploy Next.js
            echo "Deploying Next.js application..."
            rotate_backups "${BASE_DIR}/current"
            
            TEMP_DIR="/tmp/nextjs_extract_$TIMESTAMP"
            mkdir -p "$TEMP_DIR"
            
            # Extract to a temp directory
            tar -xzf "$DEPLOY_DIR/nextjs_build.tar.gz" -C "$TEMP_DIR"
            
            # Remove old 'current' directory and replace with new build
            rm -rf "${BASE_DIR}/current"
            mv "${TEMP_DIR}" "${BASE_DIR}/current" # Move the extracted folder to the target location
            
            # 5c. Copy .env file (Ensure this file is placed on your DO server at /root/deamv_env)
            echo "Copying .env from /root/ to project directory..."
            ENV_FILE="/root/deamv_env"
            TARGET_ENV_FILE="${BASE_DIR}/current/.env"
            
            if [ -f "$ENV_FILE" ]; then
              # NOTE: Using "cp -f" ensures the .env file is overwritten if it exists
              cp -f "$ENV_FILE" "$TARGET_ENV_FILE"
              echo "Successfully copied $ENV_FILE to $TARGET_ENV_FILE"
            else
              echo "WARNING: $ENV_FILE not found! Production environment variables will be missing."
            fi
            
            # 5d. Install Production Dependencies
            echo "Installing production dependencies..."
            cd "${BASE_DIR}/current"
            # Since you excluded node_modules from the archive, you need to install production dependencies here
            npm install --production --prefer-offline 
            npm install --save-dev typescript
            
            # 5e. Restart Next.js Service
            echo "Restarting Next.js service..."
            # Assuming your Next.js service is named 'deamv' and managed by systemctl
            sudo systemctl daemon-reload
            sudo systemctl restart deamv || echo "Warning: Could not restart Next.js service. Check systemctl."

            # 5f. Cleanup
            echo "Cleaning up deployment files..."
            rm -rf "$DEPLOY_DIR/nextjs_build.tar.gz"
            
            echo "Deployment completed successfully! Next.js application is live."
